<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.board.dao.IAttatchDAO">
   <!-- PK를 첨부파일의 개수만큼 만들어야 한다. selectKey는 insert당 한번만 실행이 가능한다.
   keyProperty가 boardVO에 대해서만 존재한다.
   => 처음의 값을 어딘가에 저장해놓고 후에 일련번호를 증가해서 사용 , 몇번째로 돌리는지만 알으면 된다.(index, 0부터 시작) 
   => 시작값을 받기 위해 BoardVO에 startAttNo추가
   -->
   <insert id="insertAttatches" parameterType="BoardVO">
   <selectKey resultType="int" keyProperty="startAttNo" order="BEFORE">
   <!-- count로 하면 숫자가 중복될수도 있다.-->
      SELECT NVL(MAX(ATT_NO), 0) + 1
      FROM ATTATCH
   </selectKey>
      INSERT ALL
      <!-- 첨부파일의 개수에 따라 into의 개수가 달라짐 -->
      <foreach collection="attatchList" item="attatch" index="idx">
         INTO ATTATCH(
         		BO_NO, ATT_NO
         		, ATT_FILENAME
         		, ATT_SAVENAME
         		, ATT_SIZE
         		, ATT_CONTENTTYPE
         	)
         VALUES(
         	#{bo_no}, #{startAttNo}+#{idx}
         	, #{attatch.att_filename, jdbcType=VARCHAR}
         	, #{attatch.att_savename, jdbcType=VARCHAR}
         	, #{attatch.att_size, jdbcType=NUMERIC}
         	, #{attatch.att_contenttype, jdbcType=VARCHAR}
         	
         	)
         	
      </foreach>
      SELECT * FROM DUAL
   </insert>

</mapper>